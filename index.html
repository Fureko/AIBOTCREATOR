<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Character Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* ---------- THEME COLORS (light-by-default, dark via body[data-theme="dark"]) ---------- */
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#7b858f;
    --text:#0b1220;
    --glass: rgba(255,255,255,0.6);
    --radius:12px;
    --accent:#9D4BFF; /* purple accent */
    --accent-light: #BF8AFF;
    --btn-unselected-bg: #0b0b0b;
    --btn-unselected-text: #fff;
    --border:#e6e9ee;
    --shadow: 0 6px 20px rgba(16,24,40,0.06);
    --success: #00C875;
    --warning: #FFBE0B;
    --danger: #FF6B6B;
    --info: #4DABF7;
    
    /* Gradients */
    --gradient-purple: linear-gradient(135deg, var(--accent), var(--accent-light));
    --gradient-card: linear-gradient(145deg, var(--card), var(--card));
  }
  
  body[data-theme="dark"]{
    --bg:#0b0f14;
    --card:#161B22;
    --muted:#98a3af;
    --text:#e6eef8;
    --glass: rgba(30,30,35,0.8);
    --accent:#9D4BFF;
    --accent-light: #BF8AFF;
    --btn-unselected-bg: #0a0a0a;
    --btn-unselected-text: #fff;
    --border: rgba(255,255,255,0.08);
    --shadow: 0 8px 30px rgba(0,0,0,0.6);
    --gradient-card: linear-gradient(145deg, var(--card), #1A2028);
  }

  /* ---------- BASE ---------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
    transition: background-color .25s, color .25s;
    background-image: radial-gradient(circle at 50% 50%, rgba(157,75,255,0.06) 0%, transparent 70%);
  }

  .app{
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:20px;
  }
  @media (max-width:980px){ .app{grid-template-columns:1fr;padding:18px} }

  header{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .brand h1{
    font-size:16px;
    margin:0;
    font-weight:800;
    background: var(--gradient-purple);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    display: inline-block;
  }
  .brand p{
    margin:4px 0 0;
    color:var(--muted);
    font-size:13px;
    font-weight:500;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .btn{
    border:0;
    padding:8px 16px;
    border-radius:10px;
    background:var(--glass);
    color:var(--text);
    cursor:pointer;
    font-weight:600;
    font-size:13px;
    transition: all 0.2s ease;
    border: 1px solid var(--border);
    backdrop-filter: blur(8px);
  }
  .btn:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .btn.primary{
    background: var(--gradient-purple);
    color:white;
    box-shadow: 0 8px 24px rgba(157,75,255,0.2);
    border: 1px solid rgba(157,75,255,0.2);
  }
  .btn.primary:hover {
    box-shadow: 0 10px 28px rgba(157,75,255,0.3);
  }

  main.left, aside.right{
    background:var(--gradient-card);
    border-radius:var(--radius);
    padding:0;
    min-height:640px;
    overflow:hidden;
    border: 1px solid var(--border);
  }

  /* ---------- CARDS ---------- */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:var(--shadow);
    transition: all 0.2s ease;
  }
  .card:hover {
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  .card + .card{margin-top:12px}

  /* ---------- ACCORDIONS ---------- */
  .accordion{
    margin-bottom:12px;
    border-radius:10px;
    overflow:hidden;
    transition: all 0.2s ease;
  }
  .accordion:hover {
    transform: translateY(-1px);
  }
  .acc-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 14px;
    cursor:pointer;
    gap:12px;
    border-bottom:1px solid var(--border);
    transition: background-color 0.2s ease;
  }
  .acc-head:hover {
    background: var(--glass);
  }
  .acc-title{
    font-weight:700;
    color: var(--accent);
  }
  .acc-body{
    padding:12px 14px;
    display:none;
    background:transparent;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .acc-body.open{display:block}

  label{
    display:block;
    font-size:13px;
    margin-bottom:6px;
    color:var(--muted);
    font-weight:600;
  }
  input[type="text"], textarea, select{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    resize:vertical;
    font-size:14px;
    transition: all 0.2s ease;
  }
  input[type="text"]:focus, textarea:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(157,75,255,0.2);
    outline: none;
  }
  textarea{min-height:64px}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:640px){.row{grid-template-columns:1fr}}

  /* ---------- Personality assistant (traits) ---------- */
  .traits { display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;align-items:center }
  .trait-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 12px;
    border-radius:999px;
    border:2px solid transparent;
    font-weight:600;
    font-size:13px;
    color:var(--btn-unselected-text);
    background:var(--btn-unselected-bg);
    cursor:pointer;
    transition:all 0.2s ease;
    box-shadow: 0 2px 6px rgba(2,6,23,0.06);
  }
  .trait-btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .trait-btn.selected{
    background:var(--accent) !important;
    color: #fff !important;
    border-color: transparent !important;
    box-shadow: 0 8px 22px rgba(157,75,255,0.2);
  }

  .trait-cat{
    font-size:12px;
    margin-top:16px;
    margin-bottom:8px;
    color:var(--muted);
    font-weight:700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ---------- Right column tabs ---------- */
  .tabs{
    display:flex;
    gap:8px;
    margin-bottom:12px;
    flex-wrap:wrap;
  }
  .tab{
    padding:8px 16px;
    border-radius:10px;
    background:var(--glass);
    cursor:pointer;
    font-weight:700;
    color:var(--muted);
    border: 1px solid var(--border);
    transition: all 0.2s ease;
  }
  .tab:hover {
    transform: translateY(-1px);
  }
  .tab.active{
    background: var(--gradient-purple);
    color:white;
    border-color: transparent;
  }

  /* ---------- preview ---------- */
  .preview{
    background: var(--card);
    border-radius:10px;
    padding:12px;
    white-space:pre-wrap;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    font-size:13px;
    color:var(--muted);
    overflow:auto;
    max-height:420px;
    border: 1px solid var(--border);
  }

  .tiny{
    font-size:12px;
    color:var(--muted);
    opacity: 0.8;
  }
  .copy-row{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    margin-top:8px
  }

  /* neat spacing for small panels */
  .muted-block{
    background:var(--card);
    border-radius:10px;
    padding:16px;
    border:1px solid var(--border);
    transition: all 0.2s ease;
  }
  .muted-block:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  /* small responsive tweaks */
  .right-grid{display:grid;grid-template-columns:1fr;gap:12px}

  /* Footer */
  footer {
    grid-column:1/-1;
    margin-top:14px;
    color:var(--muted);
    font-size:13px;
    text-align:center;
    padding: 12px;
    border-radius: 8px;
    background: var(--glass);
    border: 1px solid var(--border);
  }

  /* Loading animation */
  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
  .loading {
    animation: pulse 1.5s ease-in-out infinite;
  }
</style>
</head>
<body data-theme="light">
<div class="app" role="application" aria-label="OC Profile Builder">
  <header>
    <div class="brand">
      <div>
<h1>AI Character Builder</h1>
<p class="tiny">
  Template made by 
  <a href="https://janitorai.com/profiles/ae3b8516-54d5-4469-8557-6dcf808128d0_profile-of-iorveths" 
     target="_blank" rel="noopener noreferrer">@Ioverths</a>
</p>
<p class="tiny">
  Website made by 
  <a href="https://janitorai.com/profiles/0977574d-406b-430b-9d15-fb217143c932_profile-of-fureko" 
     target="_blank" rel="noopener noreferrer">@Fureko</a>
</p>

      </div>
    </div>

    <div class="controls">
      <button id="themeToggle" class="btn" title="Toggle Day / Night" aria-label="Toggle theme">ðŸŒ—</button>
      <button id="resetBtn" class="btn" title="Reset all fields" aria-label="Reset form">Reset</button>
    </div>
  </header>

  <main class="left">
    <div class="card">
      <!-- NPCs -->
      <section class="accordion" id="acc-npcs">
        <div class="acc-head" data-target="npcs" tabindex="0">
          <div><div class="acc-title">NPCs</div><div class="tiny">One NPC per line</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-npcs">
          <label for="npcsInput">NPCs block</label>
          <textarea id="npcsInput" placeholder="e.g. &lt;Name, black hair, green eyes, tall, gruff, guard&gt;"></textarea>
        </div>
      </section>

      <!-- Core -->
      <section class="accordion" id="acc-core">
        <div class="acc-head" data-target="core" tabindex="0">
          <div><div class="acc-title">Core identity</div><div class="tiny">Name, aliases, species, role</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-core">
          <div class="row">
            <div>
              <label>Full Name</label>
              <input id="fullName" type="text" placeholder="First Last" />
            </div>
            <div>
              <label>Aliases</label>
              <input id="aliases" type="text" placeholder="nicknames, callsigns ..." />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div><label>Species (optional)</label><input id="species" type="text" /></div>
            <div><label>Age</label><input id="age" type="text" /></div>
          </div>
          <div style="margin-top:10px"><label>Occupation / Role</label><input id="role" type="text" /></div>
          <div style="margin-top:10px"><label>Current Residence</label><input id="residence" type="text" placeholder="location + short description" /></div>
        </div>
      </section>

      <!-- Appearance -->
      <section class="accordion" id="acc-appearance">
        <div class="acc-head" data-target="appearance" tabindex="0">
          <div><div class="acc-title">Appearance & Clothing</div><div class="tiny">Scent, clothing, marks</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-appearance">
          <label>Appearance (brief)</label>
          <textarea id="appearance" placeholder="Height, build, hair, eyes, distinguishing marks..."></textarea>
          <div class="row" style="margin-top:10px">
            <div><label>Scent</label><input id="scent" type="text" placeholder="wood smoke, sea salt..." /></div>
            <div><label>Clothing</label><input id="clothing" type="text" placeholder="uniform, leather pants..." /></div>
          </div>
        </div>
      </section>

      <!-- Backstory -->
      <section class="accordion" id="acc-backstory">
        <div class="acc-head" data-target="backstory" tabindex="0">
          <div><div class="acc-title">Backstory</div><div class="tiny">Concise but complete</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-backstory">
          <label>Backstory</label>
          <textarea id="backstory" placeholder="Use bullets or paragraphs"></textarea>
        </div>
      </section>

      <!-- Relationships -->
      <section class="accordion" id="acc-relationships">
        <div class="acc-head" data-target="relationships" tabindex="0">
          <div><div class="acc-title">Relationships</div><div class="tiny">One per paragraph</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-relationships">
          <label>Relationships</label>
          <textarea id="relationships" placeholder='e.g. "User - loyal companion. \"I would die for you.\"'></textarea>
        </div>
      </section>

      <!-- Personality -->
      <section class="accordion" id="acc-personality">
        <div class="acc-head" data-target="personality" tabindex="0">
          <div><div class="acc-title">Personality</div><div class="tiny">Traits, Likes, Dislikes, Insecurities, Behavior, Opinion</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body open" id="body-personality">
          <label>Traits (click buttons to add)</label>
          <textarea id="traits" placeholder="Selected traits appear here (trait1, trait2, ...)" style="min-height:60px"></textarea>

          <div class="trait-cat">Quick assistant â€” categories (click to open)</div>
          <div id="traitsContainer" class="traits" aria-hidden="false">
            <!-- JSON-driven accordions will be injected here -->
            <div class="tiny" style="width:100%;">Loading trait categoriesâ€¦</div>
          </div>

          <div class="tiny hint" style="margin-top:10px">Use the category headers to expand lists. Click a trait to toggle it on/off.</div>

          <div style="margin-top:12px">
            <label>Likes</label>
            <textarea id="likes" placeholder="Likes..."></textarea>

            <label style="margin-top:8px">Dislikes</label>
            <textarea id="dislikes" placeholder="Dislikes..."></textarea>

            <label style="margin-top:8px">Insecurities</label>
            <textarea id="insecurities" placeholder="Insecurities..."></textarea>

            <label style="margin-top:8px">Physical behaviour</label>
            <textarea id="physicalBehaviour" placeholder="Quirks, posture, habits..."></textarea>

            <label style="margin-top:8px">Opinion</label>
            <textarea id="opinion" placeholder="Strong beliefs, religion, politics (optional)..."></textarea>
          </div>
        </div>
      </section>

      <!-- Intimacy -->
      <section class="accordion" id="acc-intimacy">
        <div class="acc-head" data-target="intimacy" tabindex="0">
          <div><div class="acc-title">Intimacy (optional)</div><div class="tiny">Turn-ons / During Sex</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-intimacy">
          <label>Turn-ons</label>
          <textarea id="turnOns" placeholder="Turn-ons..."></textarea>
          <label style="margin-top:8px">During Sex</label>
          <textarea id="duringSex" placeholder="Behaviour during sex..."></textarea>
        </div>
      </section>

      <!-- Dialogue -->
      <section class="accordion" id="acc-dialogue">
        <div class="acc-head" data-target="dialogue" tabindex="0">
          <div><div class="acc-title">Dialogue</div><div class="tiny">Speech patterns & sample lines</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-dialogue">
          <p class="tiny">[These are merely examples of how <strong id="charNameUpper">CHARACTER NAME</strong> may speak and should NOT be used verbatim.]</p>

          <label>Greeting Example</label>
          <textarea id="greetingExample" placeholder='e.g. "Good day, stranger."'></textarea>

          <label style="margin-top:8px">Surprised</label>
          <textarea id="surprised" placeholder="e.g. &quot;What?! That can't be...&quot;"></textarea>

          <label style="margin-top:8px" for="stressed">Stressed</label>
          <textarea id="stressed" placeholder="e.g. 'I don't have time for this!'"></textarea>


          <label style="margin-top:8px">Memory</label>
          <textarea id="memory" placeholder='Short memory trigger line...'></textarea>

          <label style="margin-top:8px">Opinion</label>
          <textarea id="opinionDialogue" placeholder='Short opinion line...'></textarea>
        </div>
      </section>

      <!-- Notes -->
      <section class="accordion" id="acc-notes">
        <div class="acc-head" data-target="notes" tabindex="0">
          <div><div class="acc-title">Notes</div><div class="tiny">Fun facts, allergies, secrets</div></div>
          <div class="tiny">toggle</div>
        </div>
        <div class="acc-body" id="body-notes">
          <label>Notes</label>
          <textarea id="notes" placeholder="Any extra notes..."></textarea>
        </div>
      </section>
    </div>
  </main>

  <aside class="right">
    <div class="right-grid">
      <div class="muted-block card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="tiny">Template Tabs</div>
            <div style="font-weight:700">Scenario / Messages / Preview</div>
          </div>
          <div>
            <button id="saveBtn" class="btn primary tiny">Save</button>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Editor tabs" style="margin-top:12px">
          <div class="tab active" data-tab="scenario">Scenario / Setting</div>
          <div class="tab" data-tab="initial">Initial Message</div>
          <div class="tab" data-tab="examples">Example Dialogue</div>
          <div class="tab" data-tab="preview">Preview</div>
        </div>

        <div id="tabScenario" style="display:block">
          <label>Scenario / Setting</label>
          <textarea id="scenario" placeholder="[world, era, tech, beliefs...]" style="height:160px"></textarea>
          <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">
            <button class="btn" id="copyScenario">Copy</button>
          </div>
        </div>

        <div id="tabInitial" style="display:none">
          <label>Initial Message</label>
          <textarea id="initial" placeholder="First message the character sends..." style="height:140px"></textarea>
          <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">
            <button class="btn" id="copyInitial">Copy</button>
          </div>
        </div>

        <div id="tabExamples" style="display:none">
          <label>Example Dialogue</label>
          <textarea id="examples" placeholder="Short sample exchanges..." style="height:140px"></textarea>
          <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">
            <button class="btn" id="copyExamples">Copy</button>
          </div>
        </div>

        <div id="tabPreview" style="display:none;margin-top:8px">
          <div class="tiny">Live assembled template</div>
          <div id="previewBox" class="preview" aria-live="polite"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn primary" id="copyAll">Copy Full Template</button>
          </div>
        </div>
      </div>

      <div class="muted-block card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="tiny">Quick export</div>
          <div class="tiny">Clipboard only</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" id="copyPersonality2">Copy Personality</button>
          <button class="btn" id="copyScenario2">Copy Scenario</button>
          <button class="btn" id="copyInitial2">Copy Initial</button>
          <button class="btn" id="copyExamples2">Copy Examples</button>
        </div>
      </div>

      <div class="muted-block card">
        <div><strong>Autosave</strong></div>
        <div class="tiny hint">Data stored locally. Use Reset to clear.</div>
      </div>

      <div class="muted-block card">
        <div class="tiny">Character Preview</div>
        <div id="tokenCounter" class="tiny" style="margin-top:8px">0 chars (approx)</div>
      </div>
    </div>
  </aside>

  <footer style="grid-column:1/-1;margin-top:14px;color:var(--muted);font-size:13px;text-align:center">
    Tip: click trait buttons to toggle. Use Preview to copy the full template.
  </footer>
</div>

<script>
/* ---------- UTIL ---------- */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from((ctx||document).querySelectorAll(sel));

/* ---------- TABS (right column) ---------- */
$$('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.tab;
    $('#tabScenario').style.display = (target==='scenario') ? 'block' : 'none';
    $('#tabInitial').style.display = (target==='initial') ? 'block' : 'none';
    $('#tabExamples').style.display = (target==='examples') ? 'block' : 'none';
    $('#tabPreview').style.display = (target==='preview') ? 'block' : 'none';
    if(target==='preview') updatePreview();
  });
});

/* ---------- ACCORDIONS ---------- */
$$('.acc-head').forEach(h=>{
  h.addEventListener('click', ()=>{
    const t = h.dataset.target;
    const body = document.getElementById('body-'+t);
    if(!body) return;
    body.classList.toggle('open');
  });
  h.addEventListener('keypress', (e)=>{ if(e.key==='Enter') h.click(); });
});

/* ---------- THEME TOGGLE ---------- */
const themeToggle = $('#themeToggle');
function setTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('oc_theme', t); }
themeToggle.addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') || 'light';
  setTheme(cur === 'light' ? 'dark' : 'light');
});
const savedTheme = localStorage.getItem('oc_theme') || 'light';
setTheme(savedTheme);

/* ---------- FIELDS to save ---------- */
const fields = [
  'npcsInput','fullName','aliases','species','age','role','residence',
  'appearance','scent','clothing','backstory','relationships',
  'traits','likes','dislikes','insecurities','physicalBehaviour','opinion',
  'turnOns','duringSex',
  'greetingExample','surprised','stressed','memory','opinionDialogue',
  'notes','scenario','initial','examples'
];

function saveAll(){
  fields.forEach(f=>{
    const el = $('#'+f); if(!el) return;
    localStorage.setItem('oc_'+f, el.value);
  });
  updatePreview();
  
  // Show save confirmation
  const notice = document.createElement('div');
  notice.textContent = 'âœ“ Saved locally';
  notice.style.position = 'fixed';
  notice.style.right = '20px';
  notice.style.bottom = '20px';
  notice.style.background = 'var(--success)';
  notice.style.color = 'white';
  notice.style.padding = '8px 16px';
  notice.style.borderRadius = '8px';
  notice.style.fontWeight = '600';
  notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
  notice.style.zIndex = '1000';
  notice.style.animation = 'fadeIn 0.3s ease';
  document.body.appendChild(notice);
  setTimeout(()=>{
    notice.style.animation = 'fadeIn 0.3s ease reverse';
    setTimeout(()=>notice.remove(), 300);
  }, 2000);
}

function loadAll(){
  fields.forEach(f=>{
    const el = $('#'+f); if(!el) return;
    const v = localStorage.getItem('oc_'+f);
    if(v!==null) el.value = v;
  });
  updatePreview();
}

/* ---------- COPY helpers ---------- */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    
    // Show copy confirmation
    const notice = document.createElement('div');
    notice.textContent = 'âœ“ Copied to clipboard';
    notice.style.position = 'fixed';
    notice.style.right = '20px';
    notice.style.bottom = '20px';
    notice.style.background = 'var(--success)';
    notice.style.color = 'white';
    notice.style.padding = '8px 16px';
    notice.style.borderRadius = '8px';
    notice.style.fontWeight = '600';
    notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
    notice.style.zIndex = '1000';
    notice.style.animation = 'fadeIn 0.3s ease';
    document.body.appendChild(notice);
    setTimeout(()=>{
      notice.style.animation = 'fadeIn 0.3s ease reverse';
      setTimeout(()=>notice.remove(), 300);
    }, 2000);
  }
  catch(e){
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); alert('Copied (fallback).') }catch(e){ prompt('Copy manually:', text) }
    ta.remove();
  }
}

/* Bind quick copy buttons */
$('#copyScenario')?.addEventListener('click', ()=> copyText($('#scenario').value || ''));
$('#copyInitial')?.addEventListener('click', ()=> copyText($('#initial').value || ''));
$('#copyExamples')?.addEventListener('click', ()=> copyText($('#examples').value || ''));
$('#copyScenario2')?.addEventListener('click', ()=> copyText($('#scenario').value || ''));
$('#copyInitial2')?.addEventListener('click', ()=> copyText($('#initial').value || ''));
$('#copyExamples2')?.addEventListener('click', ()=> copyText($('#examples').value || ''));

/* ---------- PREVIEW / BUILD TEMPLATE ---------- */
function buildFullTemplate(){
  const npcsRaw = $('#npcsInput')?.value.trim() || '';
  let npcsSection = '';
  if(npcsRaw){
    npcsSection = '<npcs>\\n';
    const lines = npcsRaw.split('\\n').map(s=>s.trim()).filter(Boolean);
    lines.forEach(line=> npcsSection += line + '\\n');
    npcsSection += '</npcs>\\n\\n';
  }

  let tagName = ($('#fullName')?.value || '').trim();
  if(!tagName) tagName = 'character_name';
  else tagName = tagName.replace(/\\s+/g,'_').replace(/[^a-zA-Z0-9_-]/g,'').toLowerCase();

  const core = `<${tagName}>
Full Name: ${$('#fullName')?.value || ''}
Aliases: ${$('#aliases')?.value || ''}
Species: ${$('#species')?.value || ''}
Nationality: 
Ethnicity: 
Age: ${$('#age')?.value || ''}
Occupation/Role: ${$('#role')?.value || ''}
Appearance: ${$('#appearance')?.value || ''}
Scent: ${$('#scent')?.value || ''}
Clothing: ${$('#clothing')?.value || ''}

[Backstory:
${$('#backstory')?.value || ''}
]
Current Residence: ${$('#residence')?.value || ''}

[Relationships:
${$('#relationships')?.value || ''}
]
[Personality
Traits:
${$('#traits')?.value || ''}
Likes:
${$('#likes')?.value || ''}
Dislikes:
${$('#dislikes')?.value || ''}
Insecurities:
${$('#insecurities')?.value || ''}
Physical behavour: 
${$('#physicalBehaviour')?.value || ''}
Opinion:
${$('#opinion')?.value || ''}
]
[Intimacy
Turn-ons:
${$('#turnOns')?.value || ''}
During Sex:
${$('#duringSex')?.value || ''}
]
[Dialogue
[These are merely examples of how ${($('#fullName')?.value || 'CHARACTER NAME').toUpperCase()} may speak and should NOT be used verbatim.]
Greeting Example: ${$('#greetingExample')?.value || ''}
Surprised: ${$('#surprised')?.value || ''}
Stressed: ${$('#stressed')?.value || ''}
Memory: ${$('#memory')?.value || ''}
Opinion: ${$('#opinionDialogue')?.value || ''}
]
[Notes
${$('#notes')?.value || ''}
]
</${tagName}>`;

  return npcsSection + core;
}

function updatePreview(){
  const text = buildFullTemplate();
  $('#previewBox').textContent = text;
  $('#tokenCounter').textContent = text.length + ' chars (approx)';
  $('#traits') && ($('#traits').dispatchEvent(new Event('input')));
}

/* ---------- TRAITS: load JSON, render accordions, toggle behavior ---------- */
const traitsContainer = $('#traitsContainer');
const selectedTraits = new Set();

function updateTraitsField(){
  $('#traits').value = Array.from(selectedTraits).join(', ');
  // autosave
  localStorage.setItem('oc_traits', $('#traits').value);
}

function createTraitButton(name, color){
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'trait-btn';
  btn.textContent = name;
  btn.dataset.trait = name;
  // store palette color on the element for potential use
  btn.dataset.color = color || '';
  // initial unselected appearance uses CSS var (--btn-unselected-bg)
  // Toggle logic:
  btn.addEventListener('click', ()=>{
    if(selectedTraits.has(name)){
      selectedTraits.delete(name);
      btn.classList.remove('selected');
      // restore unselected look (CSS handles it)
    } else {
      selectedTraits.add(name);
      btn.classList.add('selected');
    }
    updateTraitsField();
  });
  return btn;
}

function renderTraitsFromJSON(data){
  traitsContainer.innerHTML = '';
  data.categories.forEach((cat, index)=>{
    // category header (click to expand)
    const header = document.createElement('div');
    header.className = 'acc-head';
    header.tabIndex = 0;
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    header.style.width = '100%';
    header.style.marginTop = '6px';
    header.innerHTML = `<div style="font-weight:700;color:${cat.color}">${cat.name}</div><div class="tiny">expand</div>`;
    traitsContainer.appendChild(header);

    // body
    const body = document.createElement('div');
    body.className = 'acc-body';
    body.style.padding = '10px 0';
    body.style.display = 'none';
    body.style.width = '100%';

    // trait buttons
    cat.traits.forEach(tr=>{
      const b = createTraitButton(tr.name, cat.color);
      body.appendChild(b);
    });

    traitsContainer.appendChild(body);

    // header toggle
    header.addEventListener('click', ()=>{
      const open = body.style.display === 'block';
      body.style.display = open ? 'none' : 'block';
    });
    header.addEventListener('keypress', (e)=>{ if(e.key==='Enter') header.click(); });
  });

  // restore selection from localStorage if present
  const saved = localStorage.getItem('oc_traits') || '';
  if(saved){
    const list = saved.split(',').map(s=>s.trim()).filter(Boolean);
    list.forEach(t=>{
      selectedTraits.add(t);
      // mark button
      const btn = traitsContainer.querySelector(`[data-trait="${CSS.escape(t)}"]`);
      if(btn) btn.classList.add('selected');
    });
    updateTraitsField();
  }
}

/* fetch JSON */
fetch('personality_traits.json')
  .then(r=>{
    if(!r.ok) throw new Error('Failed to load JSON');
    return r.json();
  })
  .then(json=>{
    renderTraitsFromJSON(json);
  })
  .catch(err=>{
    traitsContainer.innerHTML = '<div class="tiny" style="color:crimson">Could not load personality_traits.json â€” put it in the same folder as this HTML.</div>';
    console.error(err);
  });

/* ---------- update name uppercase in dialogue helper ---------- */
const fullNameInput = $('#fullName');
const nameUpperEl = $('#charNameUpper');
if(fullNameInput && nameUpperEl){
  fullNameInput.addEventListener('input', ()=>{
    nameUpperEl.textContent = (fullNameInput.value || 'CHARACTER NAME').toUpperCase();
  });
}

/* ---------- attach copy / save / reset / preview ---------- */
$('#copyAll')?.addEventListener('click', ()=> copyText(buildFullTemplate()));
$('#copyPersonality2')?.addEventListener('click', ()=> copyText($('#traits').value || ''));
$('#saveBtn')?.addEventListener('click', ()=> { saveAll(); });

$('#resetBtn').addEventListener('click', ()=>{
  if(!confirm('Reset all fields? This will clear local storage for this page.')) return;
  fields.forEach(f=> localStorage.removeItem('oc_'+f));
  localStorage.removeItem('oc_traits');
  location.reload();
});

/* copy other small ones */
$('#copyScenario2')?.addEventListener('click', ()=> copyText($('#scenario').value || ''));
$('#copyInitial2')?.addEventListener('click', ()=> copyText($('#initial').value || ''));
$('#copyExamples2')?.addEventListener('click', ()=> copyText($('#examples').value || ''));

/* autosave on inputs */
fields.forEach(f=>{
  const el = $('#'+f); if(!el) return;
  el.addEventListener('input', ()=> {
    localStorage.setItem('oc_'+f, el.value);
    if(f==='traits') updatePreview();
  });
});

/* load on start */
loadAll();

/* live preview update */
function updatePreviewDebounced(){
  clearTimeout(updatePreviewDebounced._t);
  updatePreviewDebounced._t = setTimeout(updatePreview, 120);
}
$$('textarea, input').forEach(el => el.addEventListener('input', updatePreviewDebounced));

/* initial small counters */
updatePreview();

/* keyboard shortcut save */
window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='s'){
    e.preventDefault();
    saveAll();
  }
});

/* Smooth scrolling for better UX */
document.addEventListener('DOMContentLoaded', () => {
  const scrollToEl = (el) => el.scrollIntoView({
    behavior: 'smooth',
    block: 'start'
  });
  
  // Smooth scroll to sections when header is clicked
  $$('.acc-head').forEach(header => {
    header.addEventListener('click', () => {
      setTimeout(() => {
        scrollToEl(header);
      }, 100);
    });
  });
});
</script>
</body>
</html>